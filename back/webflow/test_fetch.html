<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <body>
    <h1>Test fetch</h1>
    <div>
      <label for="email">Email:</label>
      <input type="text" id="email" name="email" required /><br />

      <label for="newsType">News Type:</label>
      <input type="text" id="news_type" name="newsType" required /><br />

      <label for="daysInWeek">Days in Week:</label>
      <input type="text" id="days_in_week" name="daysInWeek" required /><br />

      <label for="phone">Phone:</label>
      <input type="text" id="phone" name="phone" required /><br />

      <button type="button" id="btn">Submit</button>
      <p id="error-text"></p>
    </div>
    <script>
      const show_error = (error) => {
        console.warn(error);
        let errorText = document.getElementById("error-text");
        if (errorText !== null) {
          if (error === "") {
            errorText.innerHTML = "";
            return;
          }
          const [firstKey, firstValue] = Object.entries(error)[0];
          console.log(firstValue);
          let text = "";
          if (Array.isArray(firstValue)) {
            text = firstValue[0];
          } else {
            text = firstValue;
          }
          if (text.indexOf("field may not be blank") !== -1) {
            text = text.replace(
              "This field",
              firstKey.charAt(0).toUpperCase() + firstKey.slice(1)
            );
          }
          errorText.innerHTML = `Error: ${text} (${firstKey})`;
        }
      };
      const get_my_headlines = (event) => {
        let headers = {
          "Content-Type": "application/json",
        };
        //   headers["Authorization"] =
        //     "Bearer " + sessionStorage.getItem(TOKEN_ACCESS_ITEM_NAME);
        let request = {
          method: "post",

          mode: "cors",
          cache: "no-cache",
          credentials: "same-origin",
          headers: headers,
          redirect: "follow",
          referrerPolicy: "no-referrer",
        };

        let email = document.getElementById("email");
        let news_type = document.getElementById("news_type");
        let days_in_week = document.getElementById("days_in_week");
        let phone = document.getElementById("phone");

        request["body"] = JSON.stringify({
          email: email.value,
          news_type: news_type.value,
          days_in_week: days_in_week.value,
          phone: phone.value,
        });
        show_error("");
        fetch("http://localhost:8000/news/api/client/add/", request)
          // fetch("https://myheadlines.pro/news/api/client/add/", request)
          .then((response) => {
            if (response.status == 200) {
              response
                .json()
                .then((response_json) => {
                  console.log(response_json[0]);
                })
                .catch((error) => show_error(error));
            } else if (response.status == 201) {
              response
                .json()
                .then((response_json) => {
                  console.log(response_json[0]);
                })
                .catch((error) => show_error(error));
            } else if (response.status == 400) {
              // get error text
              response
                .json()
                .then((response_json) => {
                  console.log(response_json);
                  show_error(response_json);
                })
                .catch((error) => show_error(error));
            } else {
              show_error({ error: `Server error (code ${response.status})` });
            }
          })
          .catch((error) => show_error(error));
      };
      let btn = document.getElementById("btn");
      btn.addEventListener("click", (event) => get_my_headlines(event));
    </script>
  </body>
</html>
